<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DCF • PV of FCFF</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Tahoma,Arial,sans-serif;background:#f8f9fc;color:#333;display:flex;height:100vh}
    .sidebar{width:220px;background:#f2f3f5;padding:30px 20px;display:flex;flex-direction:column;border-right:1px solid #ddd}
    .sidebar h2{font-size:28px;margin-bottom:30px;font-weight:700;letter-spacing:.5px}
    .nav-link{margin-bottom:18px;font-size:16px;color:#333;text-decoration:none;display:flex;justify-content:space-between}
    .nav-link:hover{color:#007bff}
    .main{flex:1;overflow:auto;padding:40px}
    .controls{display:flex;gap:14px;align-items:center;margin-bottom:20px}
    .card{background:#fff;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.06);padding:20px}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{padding:12px;text-align:right}
    th{background:#f1f3f7;color:#333;border-bottom:1px solid #ccc}
    td:first-child,th:first-child{text-align:left}
    .bold td{font-weight:700;background:#fdfdfd}
    .pv-row td{background:#fef9f1}
    .totals{display:flex;gap:20px;margin-top:16px;flex-wrap:wrap}
    .total-pill{background:#eef6ff;border:1px solid #cfe3ff;border-radius:10px;padding:12px 16px;font-weight:600}
    input[type="number"]{padding:8px 10px;border:1px solid #ccc;border-radius:8px;width:100px}
    .muted{color:#666;font-size:13px}
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>VALTUO</h2>
    <a class="nav-link" href="javascript:history.back()">Back</a>
    <a class="nav-link" href="dcf_pv.html">DCF • PV of FCFF</a>
  </div>

  <div class="main">
    <div class="controls">
      <label for="tickerSel">Ticker:</label>
      <select id="tickerSel"></select>

      <label for="rate">Discount rate:</label>
      <input id="rate" type="number" step="0.01" value="8" />
      <span class="muted">% (applied to projections only)</span>

      <button id="recalcBtn">Recalculate</button>
    </div>

    <div class="card">
      <h2 id="title">Present Value of FCFF — </h2>
      <p class="muted">DCF formula: PV = FCFF<sub>t</sub> / (1 + r)<sup>t</sup>, for t = 1..N.</p>

      <div class="table-wrap">
        <table id="pvTable">
          <thead>
            <tr id="hdrRow">
              <th>Row</th>
              <!-- years injected -->
            </tr>
          </thead>
          <tbody>
            <tr class="bold" id="fcffRow">
              <td>FCFF (Projected)</td>
            </tr>
            <tr class="pv-row" id="pvRow">
              <td>Present Value of Cash Flow</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="totals">
        <div class="total-pill">Sum of PVs: <span id="pvSum">$0</span></div>
        <div class="total-pill">Discount rate (r): <span id="rateShow">8%</span></div>
      </div>
    </div>
  </div>

  <script>
    const YEARS_DEFAULT = ['2025','2026','2027','2028','2029'];
    function fmt(n){ return Number(n).toLocaleString('en-US',{maximumFractionDigits:0}); }
    function parse(n){ return parseFloat(String(n).replace(/,/g,'')) || 0; }

    function loadStored(ticker){
      try{
        const raw = localStorage.getItem(`dcf_fcff_projection_${ticker}`);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || !Array.isArray(obj.fcff) || obj.fcff.length === 0) return null;
        return { years: obj.years || YEARS_DEFAULT, fcff: obj.fcff.map(Number) };
      }catch{ return null; }
    }

    function drawHeader(years){
      const hdr = document.getElementById('hdrRow');
      hdr.innerHTML = '<th>Row</th>' + years.map(y => `<th>${y}</th>`).join('');
    }
    function drawRow(rowId, arr){
      const tr = document.getElementById(rowId);
      tr.innerHTML = `<td>${rowId === 'fcffRow' ? 'FCFF (Projected)' : 'Present Value of Cash Flow'}</td>` +
                     arr.map(v => `<td>${fmt(v)}</td>`).join('');
    }

    function recompute(){
      const ticker = document.getElementById('tickerSel').value;
      const ratePct = parse(document.getElementById('rate').value);
      const stored = loadStored(ticker);

      if(!stored){
        alert(`No saved FCFF projections found for ${ticker}.
Visit the main DCF page, make sure projections are visible/updated, then return here.`);
        return;
      }

      const years = stored.years && stored.years.length ? stored.years : YEARS_DEFAULT;
      const fcff = stored.fcff; // in millions

      // PV_t = FCFF_t / (1 + r)^t  with t starting at 1 for first projection year
      const r = ratePct / 100.0;
      const pv = fcff.map((cf, idx) => cf / Math.pow(1 + r, idx + 1));

      drawHeader(years);
      drawRow('fcffRow', fcff);
      drawRow('pvRow', pv);

      document.getElementById('pvSum').innerText = '$' + fmt(pv.reduce((a,b)=>a+b,0));
      document.getElementById('rateShow').innerText = (ratePct.toFixed(2).replace(/\.00$/,'')) + '%';
      document.getElementById('title').innerText = `Present Value of FCFF — ${ticker}`;
    }

    (function init(){
      const sel = document.getElementById('tickerSel');
      const keys = Object.keys(localStorage).filter(k => k.startsWith('dcf_fcff_projection_'));
      const tickers = keys.map(k => k.replace('dcf_fcff_projection_','')).sort();
      sel.innerHTML = tickers.map(t => `<option>${t}</option>`).join('') || '<option>AAPL</option>';

      if(keys.length){
        const last = keys[keys.length - 1].replace('dcf_fcff_projection_','');
        sel.value = last;
      }

      document.getElementById('recalcBtn').addEventListener('click', recompute);
      document.getElementById('rate').addEventListener('change', recompute);
      sel.addEventListener('change', recompute);

      recompute();
    })();
  </script>
</body>
</html>
