<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DCF Valuation – Kubera Style (with Mid‑Year Convention)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { margin:0; font-family:'Segoe UI', Tahoma, sans-serif; background:#f8f9fc; color:#333; display:flex; height:100vh; }
    .sidebar { width:220px; background:#f2f3f5; padding:30px 20px; display:flex; flex-direction:column; border-right:1px solid #ddd; }
    .sidebar h2 { font-size:28px; margin-bottom:30px; font-weight:bold; letter-spacing:.5px; }
    .nav-link { margin-bottom:18px; font-size:16px; color:#333; text-decoration:none; display:flex; justify-content:space-between; }
    .nav-link:hover { color:#007bff; }

    .main-content { flex-grow:1; padding:40px; overflow-y:auto; }
    .top-controls { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
    .top-controls .controls { display:flex; align-items:center; gap:10px; }
    .top-controls label, .top-controls select, .top-controls button { font-size:16px; }
    .psi-link { font-size:24px; text-decoration:none; color:#007bff; font-weight:bold; }

    .table-container { background:#fff; border-radius:10px; padding:20px; box-shadow:0 3px 8px rgba(0,0,0,.05); overflow-x:auto; margin-top:20px; }
    table { width:100%; border-collapse:collapse; min-width:1200px; }
    th, td { padding:12px; text-align:right; }
    th { background:#f1f3f7; color:#333; font-size:14px; border-bottom:1px solid #ccc; }
    td { font-size:14px; }
    .bold-row td { font-weight:bold; background:#fdfdfd; }
    .projection { background:#fef9f1; }

    /* Section cards */
    .section-card { background:#fff; border-radius:12px; padding:24px; box-shadow:0 3px 8px rgba(0,0,0,.06); margin-top:30px; }
    .section-card h2 { font-family:'Inter',sans-serif; font-weight:700; font-size:22px; margin:0 0 14px; color:#004ccf; }

    #drawer { position:fixed; top:0; right:-100%; width:15%; height:100%; background:#fff; box-shadow:-2px 0 8px rgba(0,0,0,.2); transition:right .3s ease; z-index:999; display:flex; flex-direction:column; }
    #drawer.open { right:0; }
    #drawer .close-btn { align-self:flex-end; padding:12px 16px; font-size:24px; cursor:pointer; }
    #drawer iframe { border:none; width:100%; height:100%; }

    #toggleDrawer { background:#d6e9ff; color:#004ccf; border:1px solid #b5d6ff; padding:10px 18px; font-size:15px; border-radius:10px; font-family:'Inter', sans-serif; box-shadow:0 2px 6px rgba(0,0,0,.04); cursor:pointer; transition:all .25s ease; font-weight:500; letter-spacing:.3px; }
    #toggleDrawer:hover { background:#c2dcff; box-shadow:0 4px 10px rgba(0,76,207,.12); transform:translateY(-1px); }
    #toggleDrawer:active { background:#b3d2ff; transform:translateY(0); }

    /* Chart */
    canvas { margin-top:30px; background:#fff; border-radius:10px; padding:20px; box-shadow:0 3px 8px rgba(0,0,0,.05); }

    /* --- Formulas Appendix (accordion) --- */
    .accordion-card { border-radius:12px; background:#fff; box-shadow:0 3px 8px rgba(0,0,0,.06); margin-top:30px; }
    .accordion-header {
      width:100%; display:flex; align-items:center; justify-content:space-between;
      padding:18px 22px; border:none; background:transparent; cursor:pointer;
      font-family:'Inter',sans-serif; font-weight:700; font-size:22px; color:#004ccf;
    }
    .accordion-header .chev { transition:transform .2s ease; }
    .accordion-card.open .accordion-header .chev { transform:rotate(180deg); }
    .accordion-panel { max-height:0; overflow:hidden; transition:max-height .25s ease; padding:0 22px 0 22px; }
    .accordion-card.open .accordion-panel { padding:0 22px 18px 22px; }
    .formula-list h4 { margin:18px 0 6px; font-size:18px; color:#333; }
    .formula-note { color:#777; font-size:13px; margin-top:4px; }
    .math { font-size:16px; background:#f8fafc; border-radius:8px; padding:10px 12px; display:inline-block; }

    /* Tiny badge showing timing mode */
    .timing-badge { display:inline-block; margin-left:10px; padding:4px 8px; border-radius:999px; font-size:12px; background:#eef6ff; color:#0b63ce; border:1px solid #cfe3ff; }
  </style>

  <!-- MathJax for clean formulas -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(','\\)'], ['$', '$']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>

<body>
  <div class="sidebar">
    <h2>VALTUO</h2>
    <a class="nav-link" href="#">Valuation Summary</a>
    <a class="nav-link" href="#">DCF <span>$XX,XXX</span></a>
    <a class="nav-link" href="wacc.html" style="margin-left:10px;font-size:15px;">↳ WACC</a>
    <a class="nav-link" href="#">Public Comps <span>$XX,XXX</span></a>
    <a class="nav-link" href="#">Private Comps <span>$XX,XXX</span></a>
    <a class="nav-link" href="#">Fast Forward</a>
    <a class="nav-link" href="#">Beneficiary</a>
    <a class="nav-link" href="dcf_pv.html">DCF • PV of FCFF</a>
  </div>

  <div class="main-content">
    <div class="top-controls">
      <a href="home.html" class="psi-link">&Psi;</a>
      <div class="controls">
        <label for="tickerSelect">Ticker:</label>
        <select id="tickerSelect"></select>
        <button id="refreshButton">Refresh</button>
        <button id="toggleDrawer">Show raw data</button>
      </div>
    </div>

    <h1 id="mainTitle">DCF Valuation — AAPL <span id="timingBadge" class="timing-badge" title="Cash flow timing convention">Mid‑Year</span></h1>

    <!-- SECTION 1: Income Statement & Free Cash Flow Build-Up -->
    <div class="section-card">
      <h2>Income Statement & Free Cash Flow Build-Up</h2>
      <div class="table-container" style="margin-top:0;">
        <table id="dcfTable">
          <thead>
            <tr>
              <th style="text-align:left;">Metric (in millions $)</th>
              <th>2020</th><th>2021</th><th>2022</th><th>2023</th><th>2024</th>
              <th class="projection">2025</th>
              <th class="projection">2026</th>
              <th class="projection">2027</th>
              <th class="projection">2028</th>
              <th class="projection">2029</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- SECTION 2: Present Value Calculation (Kubera-style columns) -->
    <div class="section-card" id="valuationCard">
      <h2>Present Value Calculation</h2>

      <div class="controls" style="display:flex;align-items:center;gap:10px;margin:12px 0 18px;flex-wrap:wrap;">
        <label for="valRate">Discount Rate (%):</label>
        <input id="valRate" type="number" step="0.1" value="8" style="padding:8px 10px;border:1px solid #ccc;border-radius:8px;width:90px;">
        <label for="valGrowth">Growth Rate (%):</label>
        <input id="valGrowth" type="number" step="0.1" value="2" style="padding:8px 10px;border:1px solid #ccc;border-radius:8px;width:90px;">
        <label style="display:flex;align-items:center;gap:6px; padding:6px 10px; border:1px solid #cfe3ff; border-radius:8px; background:#f6fbff;">
          <input id="midYearToggle" type="checkbox" checked>
          Mid‑year convention
        </label>
        <button id="valRecalc" style="background:#007bff;color:#fff;border:none;border-radius:8px;padding:8px 16px;cursor:pointer;">Recalculate</button>
      </div>

      <div class="table-container" style="margin-top:0;">
        <table id="pvTable">
          <thead>
            <tr>
              <th style="text-align:left;">Metric</th>
              <th>2025</th>
              <th>2026</th>
              <th>2027</th>
              <th>2028</th>
              <th>2029</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="pvBody"></tbody>
        </table>
      </div>

      <h2 style="font-family:'Inter',sans-serif;font-weight:700;font-size:28px;margin-top:26px;
                 background:linear-gradient(90deg,#007bff,#00bfff);
                 -webkit-background-clip:text;color:transparent;text-shadow:0 0 10px rgba(0,123,255,.3);">
        Enterprise Value = <span id="evValue">$0</span>
      </h2>
    </div>

    <!-- Chart at bottom -->
    <canvas id="financialChart" width="1200" height="400"></canvas>

    <!-- === FORMULAS APPENDIX (Dropdown) === -->
    <section class="accordion-card" id="formulasAppendix">
      <button class="accordion-header" type="button" aria-expanded="false" aria-controls="formulasPanel">
        Formulas Appendix
        <span class="chev">▾</span>
      </button>

      <div class="accordion-panel" id="formulasPanel">
        <div class="formula-list" style="margin-top:12px;">
          <h4>Gross Profit</h4>
          <div class="math">\( \text{Gross Profit} = \text{Revenue} - \text{COGS} \)</div>

          <h4>EBIT</h4>
          <div class="math">\( \text{EBIT} = \text{Revenue} - \text{COGS} - \text{SG\&A} - \text{R\&D} \)</div>

          <h4>NOPAT</h4>
          <div class="math">\( \text{NOPAT} = \text{EBIT} - \text{Income Taxes} \)</div>

          <h4>Free Cash Flow to Firm (FCFF)</h4>
          <div class="math">\( \text{FCFF} = \text{NOPAT} + \text{D\&A} - \text{CapEx} - \Delta\text{WC} \)</div>

          <h4>Reinvestment (Projection Build)</h4>
          <div class="math">
            \( \text{Reinvestment} = \text{D\&A} + \text{Other Non\!-\!Cash} + \Delta\text{WC} + \text{Deferred Tax} - \text{CapEx} + \text{Acquisitions}_{\text{net}} \)
          </div>

          <h4>FCFF (Reinvestment variant)</h4>
          <div class="math">\( \text{FCFF(Reinv)} = \text{EBIT} - \text{Income Taxes} - \text{Reinvestment} \)</div>

          <h4>PV Factor (End‑of‑Year)</h4>
          <div class="math">\( \text{PVFactor}_t = \dfrac{1}{(1+r)^t} \)</div>

          <h4>PV Factor (Mid‑Year Convention)</h4>
          <div class="math">\( \text{PVFactor}^{\text{MYC}}_t = \dfrac{1}{(1+r)^{t-0.5}} \)</div>
          <div class="formula-note">Interpretation: yearly cash flows are earned throughout the year, so we discount each \(t\) by half a year.</div>

          <h4>Terminal Value (Gordon Growth)</h4>
          <div class="math">\( \text{TV}_T = \dfrac{\text{FCFF}_T(1+g)}{r-g} \quad (r>g) \)</div>

          <h4>Present Value of Terminal Value</h4>
          <div class="math">End‑of‑Year: \( \dfrac{\text{TV}_T}{(1+r)^T} \) &nbsp; | &nbsp; Mid‑Year: \( \dfrac{\text{TV}_T}{(1+r)^{T-0.5}} \)</div>

          <h4>Enterprise Value</h4>
          <div class="math">
            End‑of‑Year: \( \sum_{t=1}^{T} \dfrac{\text{FCFF}_t}{(1+r)^t} + \dfrac{\text{TV}_T}{(1+r)^T} \) <br/>
            Mid‑Year: \( \sum_{t=1}^{T} \dfrac{\text{FCFF}_t}{(1+r)^{t-0.5}} + \dfrac{\text{TV}_T}{(1+r)^{T-0.5}} \)
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="drawer">
    <span class="close-btn">&times;</span>
    <iframe src="calculations.html"></iframe>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_BASE = 'http://localhost:3000';
    const PROJ_GROWTH = 0.05;
    let financialChart;

    const parseNumber = (str) => parseFloat(String(str).replace(/,/g,'')) || 0;
    const formatNumber = (num) => Number(num).toLocaleString('en-US',{maximumFractionDigits:0});

    function setTimingBadge(){
      const badge = document.getElementById('timingBadge');
      const on = document.getElementById('midYearToggle').checked;
      badge.textContent = on ? 'Mid‑Year' : 'End‑of‑Year';
      badge.style.background = on ? '#eef6ff' : '#f6f6f6';
      badge.style.color = on ? '#0b63ce' : '#555';
      localStorage.setItem('dcf_midyear_enabled', on ? '1' : '0');
    }

    function updateChartFromTable(){
      if (!financialChart) return;
      const rows = document.querySelectorAll('#dcfTable tbody tr');
      const projCount = 5;
      const total = financialChart.data.labels.length;

      const getProj = (idx) => Array.from(rows[idx].cells).slice(-projCount).map(td => parseNumber(td.innerText));

      const revProjRaw   = getProj(0);
      const ebitProjRaw  = getProj(5);
      const fcfProjRaw   = getProj(10);
      const fcfReinvProj = getProj(12);

      const hist2024Rev      = financialChart.data.datasets[0].data.slice(-1)[0];
      const hist2024Ebit     = financialChart.data.datasets[1].data.slice(-1)[0];
      const hist2024Fcf      = financialChart.data.datasets[2].data.slice(-1)[0];
      const hist2024FcfReinv = financialChart.data.datasets[3].data.slice(-1)[0];

      const revFull      = [hist2024Rev,      ...revProjRaw];
      const ebitFull     = [hist2024Ebit,     ...ebitProjRaw];
      const fcfFull      = [hist2024Fcf,      ...fcfProjRaw];
      const fcfReinvFull = [hist2024FcfReinv, ...fcfReinvProj];

      const padCount = total - revFull.length;
      const pad = (cnt) => Array(Math.max(0,cnt)).fill(null);

      financialChart.data.datasets[4].data = pad(padCount).concat(revFull);
      financialChart.data.datasets[5].data = pad(padCount).concat(ebitFull);
      financialChart.data.datasets[6].data = pad(padCount).concat(fcfFull);
      financialChart.data.datasets[7].data = pad(padCount).concat(fcfReinvFull);

      financialChart.update();
    }

    function updateDCF(){
      const rows = document.querySelectorAll('#dcfTable tbody tr');
      if (rows.length === 0) return;

      const rev   = Array.from(rows[0].cells).slice(1);
      const cogs  = Array.from(rows[1].cells).slice(1);
      const gp    = Array.from(rows[2].cells).slice(1);
      const sga   = Array.from(rows[3].cells).slice(1);
      const rnd   = Array.from(rows[4].cells).slice(1);
      const ebit  = Array.from(rows[5].cells).slice(1);
      const tax   = Array.from(rows[6].cells).slice(1);
      const da    = Array.from(rows[7].cells).slice(1);
      const capex = Array.from(rows[8].cells).slice(1);
      const wc    = Array.from(rows[9].cells).slice(1);
      const fcff  = Array.from(rows[10].cells).slice(1);
      const reinv = Array.from(rows[11].cells).slice(1);
      const fcffReinv = Array.from(rows[12].cells).slice(1);

      for (let i = 0; i < rev.length; i++){
        const gpVal   = parseNumber(rev[i].innerText) - parseNumber(cogs[i].innerText);
        const ebitVal = gpVal - parseNumber(sga[i].innerText) - parseNumber(rnd[i].innerText);

        gp[i].innerText   = formatNumber(gpVal);
        ebit[i].innerText = formatNumber(ebitVal);

        // FCFF (classic): NOPAT + D&A - CapEx - ΔWC
        const nopat   = ebitVal - parseNumber(tax[i].innerText);
        const fcffVal = nopat + parseNumber(da[i].innerText) - parseNumber(capex[i].innerText) - parseNumber(wc[i].innerText);
        fcff[i].innerText = formatNumber(fcffVal);

        // Projection-only: Reinvestment & FCFF(Reinvestment)
        const isProjection = (i >= 5);
        if (isProjection){
          const other    = (window._carry?.other    ?? 0);
          const deferred = (window._carry?.deferred ?? 0);
          const acq      = (window._carry?.acq      ?? 0);

          const reinvestmentVal =
              parseNumber(da[i].innerText)
            + other
            + parseNumber(wc[i].innerText)
            + deferred
            - parseNumber(capex[i].innerText)
            + acq;

          reinv[i].innerText = formatNumber(reinvestmentVal);

          const fcffReinvVal = ebitVal - parseNumber(tax[i].innerText) - reinvestmentVal;
          fcffReinv[i].innerText = formatNumber(fcffReinvVal);
        }
      }

      // Persist FCFF projections for PV section
      const projCount = 5;
      const fcffProj = fcff.slice(-projCount).map(td => parseNumber(td.innerText));
      const yearsProj = ['2025','2026','2027','2028','2029'];

      if (window._currentTicker){
        localStorage.setItem(
          `dcf_fcff_projection_${window._currentTicker}`,
          JSON.stringify({ ticker: window._currentTicker, years: yearsProj, fcff: fcffProj })
        );
      }

      updateChartFromTable();
      recalcValuation();
    }

    async function renderChart(data){
      const ctx = document.getElementById('financialChart').getContext('2d');
      if (financialChart) financialChart.destroy();

      const g = (c) => {
        const grad = ctx.createLinearGradient(0,0,0,400);
        grad.addColorStop(0,c.replace('1)', '0.4)'));
        grad.addColorStop(1,c.replace('1)', '0)'));
        return grad;
      };

      financialChart = new Chart(ctx, {
        type:'line',
        data:{
          labels:[...data.labels,'2025','2026','2027','2028','2029'],
          datasets:[
            { label:'Revenue (Historical)', data:data.revenue, borderColor:'#007bff', backgroundColor:g('rgba(0,123,255,1)'), fill:true, tension:.3 },
            { label:'EBIT (Historical)',    data:data.ebit,    borderColor:'#28a745', backgroundColor:g('rgba(40,167,69,1)'), fill:true, tension:.3 },
            { label:'FCFF (Historical)',    data:data.fcff,    borderColor:'#ffc107', backgroundColor:g('rgba(255,193,7,1)'), fill:true, tension:.3 },
            { label:'FCFF (Reinvestment) (Historical)', data:data.fcff_reinvestment, borderColor:'#dc3545', backgroundColor:g('rgba(220,53,69,1)'), fill:true, tension:.3 },
            { label:'Revenue (Projected)',  data:[], borderColor:'#007bff', borderDash:[5,5], fill:false, tension:.3 },
            { label:'EBIT (Projected)',     data:[], borderColor:'#28a745', borderDash:[5,5], fill:false, tension:.3 },
            { label:'FCFF (Projected)',     data:[], borderColor:'#ffc107', borderDash:[5,5], fill:false, tension:.3 },
            { label:'FCFF (Reinvestment) (Projected)', data:[], borderColor:'#dc3545', borderDash:[5,5], fill:false, tension:.3 },
          ]
        },
        options:{
          responsive:true,
          plugins:{ legend:{ position:'top' }, title:{ display:true, text:'Historical + Projected Financials' } },
          interaction:{ mode:'nearest', axis:'x', intersect:false },
          scales:{ y:{ beginAtZero:true, title:{ display:true, text:'Millions USD' } }, x:{ title:{ display:true, text:'Fiscal Year' } } }
        }
      });
    }

    async function populateHistoricalData(ticker){
      try{
        const res = await fetch(`${API_BASE}/filtered-financials?company=${ticker}`);
        if (!res.ok) throw new Error(res.statusText);
        const raw = await res.json();

        const grouped = {};
        raw.forEach(row => {
          const y = row.calendar_year;
          if (!grouped[y]) grouped[y] = { revenue:0,cogs:0,sga:0,rnd:0,da:0,capex:0,wc:0,tax:0,other:0,deferred:0,acq:0 };
          grouped[y].revenue  += (row.revenue||0)/1e6;
          grouped[y].cogs     += (row.cogs   ||0)/1e6;
          grouped[y].sga      += (row.sga    ||0)/1e6;
          grouped[y].rnd      += (row.rnd    ||0)/1e6;
          grouped[y].da       += (row.da     ||0)/1e6;
          grouped[y].capex    += (row.capex  ||0)/1e6;
          grouped[y].wc       += (row.wc     ||0)/1e6;
          grouped[y].other    += (row.other_non_cash_items ||0)/1e6;
          grouped[y].deferred += (row.deferred_income_tax  ||0)/1e6;
          grouped[y].acq      += (row.acquisitions_net     ||0)/1e6;
          grouped[y].tax      += (row.tax    ||0)/1e6;
        });

        const years = [2020,2021,2022,2023,2024];
        const lastYear = years[years.length-1];

        // carry-forward used in projections for reinvestment build
        window._carry = {
          other:    (grouped[lastYear]?.other    ?? 0),
          deferred: (grouped[lastYear]?.deferred ?? 0),
          acq:      (grouped[lastYear]?.acq      ?? 0)
        };

        const keyMap = {
          'Revenue':'revenue','COGS':'cogs','SG&A':'sga','R&D':'rnd',
          'Income Tax':'tax','D&A':'da','CapEx':'capex','Δ Working Capital':'wc'
        };

        const metrics = [
          'Revenue','COGS','Gross Profit','SG&A','R&D',
          'Operating Income (EBIT)','Income Tax','D&A','CapEx',
          'Δ Working Capital','FCFF','Reinvestment','FCFF (Reinvestment)'
        ];

        const tbody = document.querySelector('#dcfTable tbody');
        tbody.innerHTML = '';

        const chartData = { labels: years.map(String), revenue:[], ebit:[], fcff:[], fcff_reinvestment:[] };

        metrics.forEach(metric => {
          const row = document.createElement('tr');
          if (['Gross Profit','Operating Income (EBIT)','FCFF','FCFF (Reinvestment)'].includes(metric)) {
            row.classList.add('bold-row');
          }

          const labelCell = document.createElement('td');
          labelCell.innerText = metric;
          labelCell.style.textAlign = 'left';
          row.appendChild(labelCell);

          years.forEach(y => {
            const td = document.createElement('td');
            let val = '-';
            if (grouped[y]){
              const g = grouped[y];
              switch(metric){
                case 'Revenue': val=g.revenue; chartData.revenue.push(val); break;
                case 'COGS': val=g.cogs; break;
                case 'Gross Profit': val=g.revenue - g.cogs; break;
                case 'SG&A': val=g.sga; break;
                case 'R&D': val=g.rnd; break;
                case 'Operating Income (EBIT)': {
                  const ebit=g.revenue - g.cogs - g.sga - g.rnd; val=ebit; chartData.ebit.push(val); break;
                }
                case 'Income Tax': val=g.tax; break;
                case 'D&A': val=g.da; break;
                case 'CapEx': val=g.capex; break;
                case 'Δ Working Capital': val=g.wc; break;
                case 'Reinvestment': {
                  const reinv=g.da + g.other + g.wc + g.deferred - g.capex + g.acq; val=reinv; break;
                }
                case 'FCFF': {
                  const e=g.revenue - g.cogs - g.sga - g.rnd; const np=e - g.tax;
                  /* FCFF classic: NOPAT + D&A - CapEx - ΔWC */
                  val=np + g.da - g.capex - g.wc; chartData.fcff.push(val); break;
                }
                case 'FCFF (Reinvestment)': {
                  const ebit=g.revenue - g.cogs - g.sga - g.rnd;
                  const reinv=g.da + g.other + g.wc + g.deferred - g.capex + g.acq;
                  val=ebit - g.tax - reinv; chartData.fcff_reinvestment.push(val); break;
                }
              }
            }
            td.innerText = (typeof val === 'number') ? formatNumber(val) : val;
            row.appendChild(td);
          });

          // Projections (2025..2029)
          for (let i = 0; i < 5; i++){
            const td = document.createElement('td');
            td.classList.add('projection');

            if (keyMap[metric]){
              td.contentEditable = true;
              const baseVal = grouped[lastYear] ? grouped[lastYear][keyMap[metric]] : 0;
              const projVal = baseVal * Math.pow(1 + PROJ_GROWTH, i + 1);
              td.innerText = formatNumber(projVal);
              td.addEventListener('input', updateDCF);
              td.addEventListener('keydown', e => { if (e.key === 'Enter'){ e.preventDefault(); updateDCF(); } });
            } else {
              td.innerText = '-';
            }
            row.appendChild(td);
          }

          tbody.appendChild(row);
        });

        await renderChart(chartData);
        updateDCF();
      } catch (e){
        console.error('Error fetching financials:', e);
      }
    }

    // === DCF Valuation Summary (LocalStorage Option, column layout) ===
    function recalcValuation(){
      const ticker = window._currentTicker;
      const stored = ticker ? localStorage.getItem(`dcf_fcff_projection_${ticker}`) : null;

      const pvBody = document.getElementById('pvBody');
      const evElem = document.getElementById('evValue');

      const fmt = (n) => (n == null || isNaN(n)) ? '-' : Number(n).toLocaleString('en-US',{maximumFractionDigits:0});
      const rowHtml = (label, arr, total=null) => {
        const t = (total==null) ? '' : fmt(total);
        return `
          <tr${label==='Discounted Cash Flows' || label==='Present Value of Terminal Value' ? ' class="bold-row"' : ''}>
            <td style="text-align:left;">${label}</td>
            <td>${fmt(arr[0])}</td>
            <td>${fmt(arr[1])}</td>
            <td>${fmt(arr[2])}</td>
            <td>${fmt(arr[3])}</td>
            <td>${fmt(arr[4])}</td>
            <td>${t}</td>
          </tr>`;
      };

      if(!stored){
        pvBody.innerHTML = '';
        evElem.innerText = '$0';
        return;
      }

      const { fcff } = JSON.parse(stored) || {};
      if (!fcff || fcff.length !== 5){
        pvBody.innerHTML = '';
        evElem.innerText = '$0';
        return;
      }

      const r = parseFloat(document.getElementById('valRate').value)/100;
      const g = parseFloat(document.getElementById('valGrowth').value)/100;
      const useMidYear = document.getElementById('midYearToggle').checked;

      const t = fcff.map((_,i)=>i+1);
      const effectivePeriods = t.map(v => useMidYear ? (v - 0.5) : v);
      const pvFactors = effectivePeriods.map(v => 1/Math.pow(1+r, v));
      const discounted = fcff.map((cf,i) => cf * pvFactors[i]);
      const sumPV = discounted.reduce((a,b)=>a+b,0);

      const lastFCFF = fcff[fcff.length-1];
      const tv = lastFCFF * (1 + g) / (r - g);

      const tvFactor = 1/Math.pow(1+r, useMidYear ? (t[t.length-1] - 0.5) : t[t.length-1]);
      const pvTV = tv * tvFactor;

      const ev = sumPV + pvTV;

      const blank = [null,null,null,null,null];
      const timePeriodsArr = effectivePeriods.map(v => Number(v.toFixed(1)));
      const pvFactorsArr   = pvFactors.map(v => Number.isFinite(v) ? Number(v.toFixed(3)) : null);
      const discountedArr  = discounted;

      const tvArr          = blank.slice();      tvArr[4] = tv;
      const tvFactorArr    = blank.slice();      tvFactorArr[4] = Number(tvFactor.toFixed(3));
      const pvTvArr        = blank.slice();      pvTvArr[4] = pvTV;

      pvBody.innerHTML = [
        rowHtml('Unlevered Free Cash Flow', fcff, null),
        rowHtml('Time Period (years)', timePeriodsArr, null),
        rowHtml('Present Value Factor', pvFactorsArr, null),
        rowHtml('Discounted Cash Flows', discountedArr, sumPV),
        rowHtml('Terminal Value', tvArr, tv),
        rowHtml('PV Factor (for TV)', tvFactorArr, tvFactor),
        rowHtml('Present Value of Terminal Value', pvTvArr, pvTV),
        `<tr class="bold-row">
           <td style="text-align:left;">Enterprise Value</td>
           <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
           <td>${fmt(ev)}</td>
         </tr>`
      ].join('');

      evElem.innerText = '$' + ev.toLocaleString('en-US',{maximumFractionDigits:0});
      evElem.style.transition = 'all 0.3s ease';
      evElem.style.transform = 'scale(1.15)';
      evElem.style.textShadow = '0 0 15px rgba(0,123,255,.6)';
      setTimeout(()=>{
        evElem.style.transform = 'scale(1)';
        evElem.style.textShadow = '0 0 10px rgba(0,123,255,.3)';
      },300);

      setTimingBadge();
    }

    // Accordion toggle for Formulas Appendix
    (function () {
      const card = document.getElementById('formulasAppendix');
      if (!card) return;
      const header = card.querySelector('.accordion-header');
      const panel  = card.querySelector('.accordion-panel');

      function setOpen(isOpen){
        card.classList.toggle('open', isOpen);
        header.setAttribute('aria-expanded', String(isOpen));
        if (isOpen) {
          panel.style.maxHeight = panel.scrollHeight + 'px';
        } else {
          panel.style.maxHeight = '0px';
        }
      }
      setOpen(false);
      header.addEventListener('click', () => setOpen(!card.classList.contains('open')));
      window.addEventListener('resize', () => {
        if (card.classList.contains('open')) panel.style.maxHeight = panel.scrollHeight + 'px';
      });
    })();

    // Wire controls + initial load
    document.getElementById('valRecalc').addEventListener('click', recalcValuation);

    document.addEventListener('DOMContentLoaded', async () => {
      const tickerSelect = document.getElementById('tickerSelect');
      const refreshBtn   = document.getElementById('refreshButton');
      const mainTitle    = document.getElementById('mainTitle');
      const drawer       = document.getElementById('drawer');
      const toggleBtn    = document.getElementById('toggleDrawer');
      const closeBtn     = drawer.querySelector('.close-btn');
      const iframe       = drawer.querySelector('iframe');

      // restore mid-year preference
      const pref = localStorage.getItem('dcf_midyear_enabled');
      if (pref !== null) {
        document.getElementById('midYearToggle').checked = (pref === '1');
        setTimingBadge();
      }

      try {
        const res = await fetch(`${API_BASE}/companies`);
        const list = await res.json();
        tickerSelect.innerHTML = list.map(t => `<option>${t}</option>`).join('');
      } catch (e) {
        console.error('Error loading tickers:', e);
      }

      async function loadTicker(t){
        window._currentTicker = t;
        mainTitle.childNodes[0].nodeValue = `DCF Valuation — ${t} `; // keep badge intact
        iframe.src = `calculations.html?ticker=${t}`;
        await populateHistoricalData(t);
        recalcValuation();
      }

      await loadTicker(tickerSelect.value || 'AAPL');

      tickerSelect.addEventListener('change', () => loadTicker(tickerSelect.value));
      refreshBtn.addEventListener('click',   () => loadTicker(tickerSelect.value));

      toggleBtn.addEventListener('click', () => drawer.classList.add('open'));
      closeBtn.addEventListener('click', () => drawer.classList.remove('open'));
      document.addEventListener('click', e => {
        if (drawer.classList.contains('open') && !drawer.contains(e.target) && e.target !== toggleBtn) {
          drawer.classList.remove('open');
        }
      });

      // Recalc when timing convention toggles
      document.getElementById('midYearToggle').addEventListener('change', recalcValuation);
    });
  </script>
</body>
</html>

