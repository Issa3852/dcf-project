<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>DCF – 5y Historical + 5y Projections (Dynamic FCFF)</title>
  <style>
    body {
      background-color: #f8f9fc;
      color: #333;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      padding: 40px;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
      color: #333;
    }
    .table-container {
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
    }
    th {
      background-color: #f1f3f7;
      color: #333;
      padding: 12px;
      font-size: 14px;
      border-bottom: 1px solid #ddd;
      text-align: right;
    }
    th:first-child {
      text-align: left;
    }
    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: right;
    }
    td:first-child {
      text-align: left;
    }
    .projection {
      background-color: #e9f5ff;
    }
    .bold-row {
      font-weight: bold;
      background-color: #fafafa;
    }
    td[contenteditable="true"] {
      background-color: #fff9e6;
      border: 1px solid #ddd;
      cursor: text;
    }
    .breakdown {
      margin-top: 40px;
      background-color: #fff;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      max-width: 900px;
      line-height: 1.6;
    }
    .psi-link {
      position: fixed;
      top: 8px;
      left: 12px;
      font-size: 28px;
      font-weight: bold;
      color: #333;
      text-decoration: none;
      background: #f1f3f7;
      padding: 5px 8px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: background 0.3s ease;
    }
    .psi-link:hover {
      background: #e1e3e7;
    }
  </style>
</head>

<body>

  <a href="home.html" class="psi-link">Ψ</a>

  <h1>DCF Valuation — AAPL</h1>

  <div class="table-container">
    <table id="dcfTable">
      <thead>
        <tr>
          <th>Metric (in millions $)</th>
          <th>2020</th>
          <th>2021</th>
          <th>2022</th>
          <th>2023</th>
          <th>2024</th>
          <th class="projection">2025</th>
          <th class="projection">2026</th>
          <th class="projection">2027</th>
          <th class="projection">2028</th>
          <th class="projection">2029</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Revenue</td>
          <td>274,515</td><td>365,817</td><td>394,328</td><td>383,285</td><td>391,035</td>
          <td class="projection" contenteditable="true">400000</td>
          <td class="projection" contenteditable="true">415000</td>
          <td class="projection" contenteditable="true">430000</td>
          <td class="projection" contenteditable="true">445000</td>
          <td class="projection" contenteditable="true">460000</td>
        </tr>
        <tr>
          <td>COGS</td>
          <td>169,559</td><td>212,981</td><td>223,546</td><td>214,137</td><td>210,352</td>
          <td class="projection" contenteditable="true">220000</td>
          <td class="projection" contenteditable="true">225000</td>
          <td class="projection" contenteditable="true">230000</td>
          <td class="projection" contenteditable="true">235000</td>
          <td class="projection" contenteditable="true">240000</td>
        </tr>
        <tr class="bold-row">
          <td>Gross Profit</td>
          <td>104,956</td><td>152,836</td><td>170,782</td><td>169,148</td><td>180,683</td>
          <td class="projection calc-gp">-</td>
          <td class="projection calc-gp">-</td>
          <td class="projection calc-gp">-</td>
          <td class="projection calc-gp">-</td>
          <td class="projection calc-gp">-</td>
        </tr>
        <tr>
          <td>SG&A</td>
          <td>19,916</td><td>21,973</td><td>25,094</td><td>24,932</td><td>26,097</td>
          <td class="projection" contenteditable="true">27000</td>
          <td class="projection" contenteditable="true">28000</td>
          <td class="projection" contenteditable="true">29000</td>
          <td class="projection" contenteditable="true">30000</td>
          <td class="projection" contenteditable="true">31000</td>
        </tr>
        <tr>
          <td>R&D</td>
          <td>18,752</td><td>21,914</td><td>26,251</td><td>29,915</td><td>31,370</td>
          <td class="projection" contenteditable="true">32000</td>
          <td class="projection" contenteditable="true">33000</td>
          <td class="projection" contenteditable="true">34000</td>
          <td class="projection" contenteditable="true">35000</td>
          <td class="projection" contenteditable="true">36000</td>
        </tr>
        <tr class="bold-row">
          <td>Operating Income (EBIT)</td>
          <td>66,288</td><td>108,949</td><td>119,437</td><td>114,301</td><td>123,216</td>
          <td class="projection calc-ebit">-</td>
          <td class="projection calc-ebit">-</td>
          <td class="projection calc-ebit">-</td>
          <td class="projection calc-ebit">-</td>
          <td class="projection calc-ebit">-</td>
        </tr>
        <tr>
          <td>Tax Rate (%)</td>
          <td>15.0</td><td>15.0</td><td>16.0</td><td>15.0</td><td>16.0</td>
          <td class="projection" contenteditable="true">16.0</td>
          <td class="projection" contenteditable="true">16.0</td>
          <td class="projection" contenteditable="true">16.0</td>
          <td class="projection" contenteditable="true">16.0</td>
          <td class="projection" contenteditable="true">16.0</td>
        </tr>
        <tr>
          <td>D&A</td>
          <td>11,056</td><td>11,284</td><td>11,104</td><td>11,519</td><td>11,445</td>
          <td class="projection" contenteditable="true">11500</td>
          <td class="projection" contenteditable="true">11600</td>
          <td class="projection" contenteditable="true">11700</td>
          <td class="projection" contenteditable="true">11800</td>
          <td class="projection" contenteditable="true">11900</td>
        </tr>
        <tr>
          <td>CapEx</td>
          <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
          <td class="projection" contenteditable="true">-12000</td>
          <td class="projection" contenteditable="true">-12500</td>
          <td class="projection" contenteditable="true">-13000</td>
          <td class="projection" contenteditable="true">-13500</td>
          <td class="projection" contenteditable="true">-14000</td>
        </tr>
        <tr>
          <td>Δ Working Capital</td>
          <td>-4,464</td><td>-</td><td>-</td><td>-</td><td>-</td>
          <td class="projection" contenteditable="true">-2000</td>
          <td class="projection" contenteditable="true">-2200</td>
          <td class="projection" contenteditable="true">-2400</td>
          <td class="projection" contenteditable="true">-2500</td>
          <td class="projection" contenteditable="true">-2600</td>
        </tr>
        <tr class="bold-row">
          <td>FCFF</td>
          <td>56,608</td><td>94,422</td><td>100,137</td><td>97,560</td><td>93,467</td>
          <td class="projection calc-fcff">-</td>
          <td class="projection calc-fcff">-</td>
          <td class="projection calc-fcff">-</td>
          <td class="projection calc-fcff">-</td>
          <td class="projection calc-fcff">-</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    function parseNumber(str) {
      return parseFloat(str.replace(/,/g, '')) || 0;
    }

    function formatNumber(num) {
      return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
    }

    async function updateDCF() {
      const table = document.getElementById('dcfTable');
      const rows = table.querySelectorAll('tbody tr');

      const rev = [...rows[0].querySelectorAll('td')].slice(5).map(td => parseNumber(td.innerText));
      const cogs = [...rows[1].querySelectorAll('td')].slice(5).map(td => parseNumber(td.innerText));
      const sga = [...rows[3].querySelectorAll('td')].slice(5).map(td => parseNumber(td.innerText));
      const rnd = [...rows[4].querySelectorAll('td')].slice(5).map(td => parseNumber(td.innerText));
      const tax_rate = [...rows[6].querySelectorAll('td')].slice(5).map(td => parseNumber(td.innerText));
      const da = [...rows[7].querySelectorAll('td')].slice(5).map(td => parseNumber(td.innerText));
      const capex = [...rows[8].querySelectorAll('td')].slice(5).map(td => parseNumber(td.innerText));
      const wc = [...rows[9].querySelectorAll('td')].slice(5).map(td => parseNumber(td.innerText));

      const payload = {
        revenue: rev,
        cogs: cogs,
        sga: sga,
        rnd: rnd,
        tax_rate: tax_rate,
        da: da,
        capex: capex,
        wc: wc
      };

      const response = await fetch('/api/run_dcf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      const gpCells = [...rows[2].querySelectorAll('td')].slice(5);
      result.gp.forEach((val, i) => {
        gpCells[i].innerText = formatNumber(val);
      });

      const ebitCells = [...rows[5].querySelectorAll('td')].slice(5);
      result.ebit.forEach((val, i) => {
        ebitCells[i].innerText = formatNumber(val);
      });

      const fcffCells = [...rows[10].querySelectorAll('td')].slice(5);
      result.fcff.forEach((val, i) => {
        fcffCells[i].innerText = formatNumber(val);
      });
    }

    document.querySelectorAll('td[contenteditable]').forEach(cell => {
      cell.addEventListener('input', function () {
        this.innerText = formatNumber(parseNumber(this.innerText));
        updateDCF();
      });
    });

    updateDCF();
  </script>

</body>
</html>
